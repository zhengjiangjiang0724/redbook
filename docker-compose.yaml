
services:
  app: 
    build:
      context: .
      dockerfile: Dockerfile
    container_name: redbook-app
    restart: unless-stopped
    environment:
      CONFIG_PATH: /app
      MYSQL_DSN: appuser:apppass@tcp(mysql:3306)/mydb?charset=utf8mb4&parseTime=True&loc=Local
      REDIS_ADDR: redis:6379
      REDIS_PASSWORD: redis123
      SERVER_PORT: ":8080"
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "8080:8080"
    networks:
      - app-network

  # ----------------------------
  # MySQL 8.0 服务
  # ----------------------------
  mysql:
    image: mysql:8.0.36      # 使用官方镜像（轻量版）
    container_name: mysql8       # 容器名
    restart: always               # 开机自启
    environment:
      MYSQL_ROOT_PASSWORD: root123  # root 密码
      MYSQL_DATABASE: mydb          # 默认数据库
      MYSQL_USER: appuser           # 应用专用用户
      MYSQL_PASSWORD: apppass       # 应用用户密码
    ports:
      - "3306:3306"               # 端口映射
    volumes:
      - mysql_data:/var/lib/mysql  # 数据持久化目录
      - ./mysql/my.cnf:/etc/mysql/my.cnf  # 可选：挂载自定义配置
    networks:
      - app-network               # 加入应用网络
    healthcheck:                  # 健康检查
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u root", "-proot123"]
      interval: 10s
      timeout: 5s
      retries: 5


  # ----------------------------
  # Redis 8 服务
  # ----------------------------
  redis:
    image: redis:8-alpine          # 官方 Redis 8 镜像（Alpine 版本）
    container_name: redis8         # 容器名
    restart: always                # 开机自启
    command:
      # 启动命令：启用密码、持久化、绑定本地地址
      redis-server --requirepass redis123
    ports:
      - "6379:6379"               # 端口映射
    volumes:
      - redis_data:/data           # 持久化数据目录
      - ./redis/redis.conf:/usr/local/etc/redis/redis.conf  # 可选：挂载配置
    networks:
      - app-network               # 加入应用网络
    healthcheck:                  # 健康检查
      test: ["CMD", "redis-cli", "-a", "redis123", "ping"]
      interval: 5s
      timeout: 3s
      retries: 3

  integration-tests:
    image: golang:1.25
    container_name: redbook-integration
    working_dir: /workspace
    command: ["go", "test", "./tests/integration", "-count=1", "-v"]
    environment:
      INTEGRATION_BASE_URL: http://app:8080/api/v1
    volumes:
      - .:/workspace
    depends_on:
      app:
        condition: service_started
    networks:
      - app-network


# ----------------------------
# 网络与数据卷 
# ----------------------------
networks:
  app-network:
    driver: bridge                # 使用 bridge 网络

volumes:
  mysql_data:                   # MySQL 数据卷
  redis_data:                   # Redis 数据卷